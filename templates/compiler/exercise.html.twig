{% extends 'base.html.twig' %}

{% block title %}Exercise - {{ exercise.language|upper }}{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow-lg">
                <div class="card-header bg-info text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-puzzle-piece"></i> Fill in the Blanks Exercise
                    </h3>
                </div>

                <div class="card-body">
                    {% if exercise.description %}
                        <div class="alert alert-primary">
                            <h5>Instructions</h5>
                            {{ exercise.description|nl2br }}
                        </div>
                    {% endif %}

                    {% if exercise.hint %}
                        <div class="alert alert-warning">
                            <strong>Hint:</strong> {{ exercise.hint }}
                        </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6">
                            <h5>Code Template</h5>
                            <p><small class="text-muted">Fill in the blanks marked with ___________</small></p>
                            <pre id="templateCode" class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ blanks.displayCode }}</pre>

                            <h5 class="mt-4">Blanks to Fill</h5>
                            <div id="blanksContainer">
                                {% for blank in blanks.blanks %}
                                    <div class="form-group mb-3">
                                        <label class="form-label">Blank #{{ blank.index }}
                                            {% if blank.hint %}
                                                <small class="text-muted">(Hint: {{ blank.hint }})</small>
                                            {% endif %}
                                        </label>
                                        <input type="text" class="form-control blank-input" 
                                               data-index="{{ blank.index }}" 
                                               placeholder="Enter code for blank #{{ blank.index }}">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5>Your Solution</h5>
                            <textarea id="userSolution" class="form-control" rows="15" placeholder="Your completed code will appear here..."></textarea>
                            <button id="validateBtn" class="btn btn-success btn-sm mt-3">
                                <i class="fas fa-check"></i> Validate Solution
                            </button>
                            <button id="compileBtn" class="btn btn-info btn-sm mt-3">
                                <i class="fas fa-play"></i> Compile & Test
                            </button>
                        </div>
                    </div>

                    <div id="resultBox" class="mt-4"></div>

                    <div class="mt-4">
                        <a href="{{ path('compiler_evaluate', {'id': exercise.evaluation.id}) }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Compiler
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const templateCode = `{{ blanks.displayCode }}`;
const solutionCode = `{{ exercise.solutionCode }}`;
const exerciseId = {{ exercise.id }};

// Update user solution when blanks are filled
document.querySelectorAll('.blank-input').forEach(input => {
    input.addEventListener('input', updateSolution);
});

function updateSolution() {
    let code = templateCode;
    const blanks = document.querySelectorAll('.blank-input');
    let blankIndex = 0;
    
    code = code.replace(/___________/g, () => {
        const input = blanks[blankIndex];
        return input ? input.value : '___________';
    });
    
    document.getElementById('userSolution').value = code;
}

document.getElementById('validateBtn').addEventListener('click', function() {
    const userCode = document.getElementById('userSolution').value;
    
    fetch('{{ path('compiler_validate_solution') }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: userCode, exerciseId: exerciseId })
    })
    .then(response => response.json())
    .then(data => {
        const resultBox = document.getElementById('resultBox');
        if (data.isCorrect) {
            resultBox.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> <strong>Correct!</strong> ${data.message}
                </div>
            `;
        } else {
            resultBox.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle"></i> <strong>Not quite right.</strong> ${data.message}
                </div>
            `;
        }
    })
    .catch(error => console.error('Error:', error));
});

document.getElementById('compileBtn').addEventListener('click', function() {
    const userCode = document.getElementById('userSolution').value;
    
    fetch('{{ path('compiler_compile') }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: userCode, language: '{{ exercise.language }}' })
    })
    .then(response => response.json())
    .then(data => {
        const resultBox = document.getElementById('resultBox');
        if (data.success) {
            resultBox.innerHTML = `
                <div class="alert alert-success">
                    <h6>Output:</h6>
                    <pre>${data.output || '[No output]'}</pre>
                </div>
            `;
        } else {
            resultBox.innerHTML = `
                <div class="alert alert-danger">
                    <h6>Compilation Error:</h6>
                    <pre>${data.error || 'Unknown error'}</pre>
                </div>
            `;
        }
    })
    .catch(error => console.error('Error:', error));
});

// Initialize
updateSolution();
</script>
{% endblock %}
