{% extends 'dashboard/index.html.twig' %}

{% block title %}User Management - Dashboard{% endblock %}

{% block page_content %}
<!--start page wrapper -->
<div class="page-wrapper">
    <div class="page-content">
        <!--breadcrumb-->
        <div class="breadcrumb-area">
            <h1>User Management</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ path('dashboard_index') }}">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">User Management</li>
                </ol>
            </nav>
        </div>
        <!--end breadcrumb-->

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">User Management</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary px-4" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="material-icons-outlined me-2">add</i>Add New User
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="debugUsers()">
                                <i class="material-icons-outlined me-1">bug_report</i>Debug
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="reloadUsers()">
                                <i class="material-icons-outlined me-1">refresh</i>Reload
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search and Filter -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="header-search">
                                    <div class="search-input">
                                        <span class="material-icons-outlined">search</span>
                                        <input type="text" class="form-control" id="searchUsers" placeholder="Search users..." autocomplete="off">
                                        <span class="search-results-count" id="searchResultsCount"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex gap-2 align-items-center">
                                    <select class="form-select" id="filterStatus">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="pending">Pending</option>
                                    </select>
                                    <select class="form-select" id="filterRole">
                                        <option value="">All Roles</option>
                                        <option value="student">Student</option>
                                        <option value="teacher">Teacher</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                    <button class="btn btn-outline-primary" onclick="exportUsers()">
                                        <i class="material-icons-outlined me-2">download</i>Export
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                        <i class="material-icons-outlined me-2">clear</i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Users Table -->
                        <div class="table-responsive">
                            <table class="table user-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input class="form-check-input" type="checkbox" id="selectAll">
                                        </th>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Last Active</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Bulk Actions -->
                        <div class="d-flex gap-2 mt-3" id="bulkActions" style="display: none;">
                            <button class="btn btn-outline-danger" onclick="deleteSelectedUsers()">
                                <i class="material-icons-outlined me-2">delete</i>Delete Selected
                            </button>
                            <button class="btn btn-outline-secondary" onclick="deselectAll()">
                                <i class="material-icons-outlined me-2">close</i>Deselect All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--end page wrapper-->

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" name="firstName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" name="lastName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Role</label>
                            <select class="form-select" name="role" required>
                                <option value="">Select Role</option>
                                <option value="student">Student</option>
                                <option value="teacher">Teacher</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Avatar</label>
                            <select class="form-select" name="avatar">
                                <option value="01.png">Avatar 1</option>
                                <option value="02.png">Avatar 2</option>
                                <option value="03.png">Avatar 3</option>
                                <option value="04.png">Avatar 4</option>
                                <option value="05.png">Avatar 5</option>
                                <option value="06.png">Avatar 6</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Save User</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId" name="id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" id="editFirstName" name="firstName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="editLastName" name="lastName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" name="email" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="editUsername" name="username" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="editRole" name="role" required>
                                <option value="student">Student</option>
                                <option value="teacher">Teacher</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editStatus" name="status" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Avatar</label>
                            <select class="form-select" id="editAvatar" name="avatar">
                                <option value="01.png">Avatar 1</option>
                                <option value="02.png">Avatar 2</option>
                                <option value="03.png">Avatar 3</option>
                                <option value="04.png">Avatar 4</option>
                                <option value="05.png">Avatar 5</option>
                                <option value="06.png">Avatar 6</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Active</label>
                            <input type="text" class="form-control" id="editLastActive" name="lastActive" readonly>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">Update User</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user? This action cannot be undone.</p>
                <p class="fw-bold" id="deleteUserName"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete User</button>
            </div>
        </div>
    </div>
</div>

<!-- User Management JavaScript -->
<script>
// User Management CRUD Operations

// Get users from database (passed from controller)
let users = {{ users|json_encode|raw }};

// Debug: Log users data
console.log('Users loaded from controller:', users);
console.log('Users count:', users.length);

// Validate users data
if (!Array.isArray(users)) {
    console.error('Users is not an array:', users);
    users = [];
} else {
    // Validate each user has required properties
    users = users.map(user => ({
        id: user.id || 0,
        name: user.name || 'Unknown User',
        email: user.email || 'unknown@example.com',
        nsc: user.nsc || 0,
        roles: Array.isArray(user.roles) ? user.roles : ['ROLE_STUDENT'],
        status: user.status || 'active'
    }));
    console.log('Validated users:', users);
}

let userToDelete = null;
let filteredUsers = [...users];

// Initialize table with users
function loadUsers() {
    const tbody = document.querySelector('.user-table tbody');
    tbody.innerHTML = '';
    
    filteredUsers.forEach(user => {
        // Parse user name to get first and last name
        const nameParts = user.name ? user.name.split(' ') : ['Unknown', 'User'];
        const firstName = nameParts[0];
        const lastName = nameParts.length > 1 ? nameParts[1] : '';
        
        // Determine role from roles array
        const role = user.roles && user.roles.includes('ROLE_ADMIN') ? 'admin' : 
                     user.roles && user.roles.includes('ROLE_ENSEIGNANT') ? 'teacher' : 'student';
        
        const roleBadge = role === 'admin' ? 'bg-danger' : 
                         role === 'teacher' ? 'bg-warning' : 'bg-info';
        
        const statusBadge = user.status === 'active' ? 'bg-success' : 
                         user.status === 'inactive' ? 'bg-danger' : 'bg-warning';
        
        const row = `
            <tr id="user-${user.id}">
                <td>
                    <input class="form-check-input user-checkbox" type="checkbox" value="${user.id}">
                </td>
                <td>
                    <div class="d-flex align-items-center gap-3">
                        <div class="user-pic">
                            <img src="{{ asset('Back_Office/assets/images/avatars/01.png') }}" class="rounded-circle" width="40" height="40" alt="">
                        </div>
                        <div>
                            <p class="mb-0 user-name fw-bold">${user.name}</p>
                            <small class="text-muted">NSC: ${user.nsc}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <a href="mailto:${user.email}" class="text-decoration-none">${user.email}</a>
                </td>
                <td>
                    <span class="badge ${roleBadge}">${role}</span>
                </td>
                <td>
                    <span class="badge ${statusBadge}">${user.status || 'Active'}</span>
                </td>
                <td>Just now</td>
                <td>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})" title="Edit">
                            <i class="material-icons-outlined">edit</i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id}, '${user.name}')" title="Delete">
                            <i class="material-icons-outlined">delete</i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
    
    updateBulkActionsVisibility();
}

// Save new user
async function saveUser() {
    const form = document.getElementById('addUserForm');
    const formData = new FormData(form);
    
    const userData = {
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        email: formData.get('email'),
        username: formData.get('username'),
        password: formData.get('password'),
        role: formData.get('role'),
        status: formData.get('status'),
        avatar: formData.get('avatar') || '01.png',
        notes: formData.get('notes')
    };
    
    try {
        const response = await fetch('{{ path('dashboard_users_create') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(userData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update users array with backend response
            if (result.users) {
                users = result.users;
                filteredUsers = [...users];
                loadUsers();
            }
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            modal.hide();
            form.reset();
            
            // Show success notification
            showNotification('User added successfully!', 'success');
        } else {
            showNotification('Error adding user', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error adding user', 'error');
    }
}

// Edit user
function editUser(userId) {
    console.log('Editing user with ID:', userId);
    console.log('Available users:', users);
    
    // Convert userId to number for proper comparison
    const numericId = parseInt(userId);
    console.log('Numeric ID:', numericId);
    
    const user = users.find(u => u.id === numericId);
    if (!user) {
        console.error('User not found with ID:', numericId);
        console.error('Available IDs:', users.map(u => u.id));
        showNotification('User not found', 'error');
        return;
    }
    
    console.log('Found user:', user);
    
    // Parse user name to get first and last name
    const nameParts = user.name ? user.name.split(' ') : ['Unknown', 'User'];
    const firstName = nameParts[0] || '';
    const lastName = nameParts.length > 1 ? nameParts[1] : '';
    
    // Determine role from roles array
    const role = user.roles && user.roles.includes('ROLE_ADMIN') ? 'admin' : 
                 user.roles && user.roles.includes('ROLE_ENSEIGNANT') ? 'teacher' : 'student';
    
    console.log('Parsed data:', { firstName, lastName, email: user.email, nsc: user.nsc, role });
    
    // Populate edit form with validation
    try {
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editFirstName').value = firstName;
        document.getElementById('editLastName').value = lastName;
        document.getElementById('editEmail').value = user.email;
        document.getElementById('editUsername').value = user.nsc || '';
        document.getElementById('editRole').value = role;
        document.getElementById('editStatus').value = user.status || 'active';
        document.getElementById('editAvatar').value = '01.png';
        document.getElementById('editLastActive').value = 'Just now';
        document.getElementById('editNotes').value = '';
        
        console.log('Form populated successfully');
    } catch (error) {
        console.error('Error populating edit form:', error);
        showNotification('Error loading user data', 'error');
        return;
    }
    
    // Show edit modal
    try {
        const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
        editModal.show();
        console.log('Edit modal shown');
    } catch (error) {
        console.error('Error showing edit modal:', error);
        showNotification('Error opening edit form', 'error');
    }
}

// Update user
async function updateUser() {
    const userId = parseInt(document.getElementById('editUserId').value);
    console.log('Updating user ID:', userId);
    
    const userData = {
        firstName: document.getElementById('editFirstName').value,
        lastName: document.getElementById('editLastName').value,
        email: document.getElementById('editEmail').value,
        username: document.getElementById('editUsername').value,
        role: document.getElementById('editRole').value,
        status: document.getElementById('editStatus').value,
        avatar: document.getElementById('editAvatar').value,
        notes: document.getElementById('editNotes').value
    };
    
    console.log('Update user data:', userData);
    
    try {
        console.log('Sending update request for user:', userId);
        console.log('Update data:', userData);
        
        const response = await fetch(`{{ path('dashboard_users_update', {'id': 'USER_ID'}) }}`.replace('USER_ID', userId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(userData)
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        const result = await response.json();
        console.log('Response result:', result);
        
        if (result.success) {
            console.log('Update successful, updating frontend...');
            // Update users array with backend response
            if (result.users) {
                users = result.users;
                filteredUsers = [...users];
                loadUsers();
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
            
            // Show success notification
            showNotification('User updated successfully!', 'success');
        } else {
            console.error('Update failed:', result);
            showNotification('Error updating user: ' + (result.message || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Network error:', error);
        showNotification('Error updating user: ' + error.message, 'error');
    }
}

// Delete user confirmation
function deleteUser(userId, userName) {
    userToDelete = parseInt(userId);
    document.getElementById('deleteUserName').textContent = userName;
    
    console.log('Delete user ID:', userToDelete);
    console.log('Delete user name:', userName);
    
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
    deleteModal.show();
}

// Confirm delete
async function confirmDelete() {
    if (userToDelete) {
        try {
            const response = await fetch(`{{ path('dashboard_users_delete', {'id': 'USER_ID'}) }}`.replace('USER_ID', userToDelete), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update users array with backend response
                if (result.users) {
                    users = result.users;
                    filteredUsers = [...users];
                    loadUsers();
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteUserModal'));
                modal.hide();
                
                // Show success notification
                showNotification('User deleted successfully!', 'success');
                
                userToDelete = null;
            } else {
                showNotification('Error deleting user', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error deleting user', 'error');
        }
    }
}

// Bulk actions
function deleteSelectedUsers() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        showNotification('Please select users to delete', 'warning');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selectedIds.length} user(s)?`)) {
        users = users.filter(user => !selectedIds.includes(user.id));
        filteredUsers = [...users];
        loadUsers();
        showNotification(`${selectedIds.length} user(s) deleted successfully!`, 'success');
    }
}

function deselectAll() {
    document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
    updateBulkActionsVisibility();
}

function updateBulkActionsVisibility() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const bulkActions = document.getElementById('bulkActions');
    bulkActions.style.display = checkboxes.length > 0 ? 'flex' : 'none';
}

// Export users
function exportUsers() {
    const csvContent = "data:text/csv;charset=utf-8," 
        + "ID,First Name,Last Name,Email,Username,Role,Status,Last Active\n"
        + filteredUsers.map(user => 
            `${user.id},${user.firstName},${user.lastName},${user.email},${user.username},${user.role},${user.status},${user.lastActive}` 
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "users_export.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Search and filter functionality
function filterUsers() {
    const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const roleFilter = document.getElementById('filterRole').value;
    
    filteredUsers = users.filter(user => {
        // Parse user name for search
        const nameParts = user.name ? user.name.split(' ') : ['Unknown', 'User'];
        const firstName = nameParts[0] || '';
        const lastName = nameParts.length > 1 ? nameParts[1] : '';
        
        // Determine role from roles array
        const role = user.roles && user.roles.includes('ROLE_ADMIN') ? 'admin' : 
                     user.roles && user.roles.includes('ROLE_ENSEIGNANT') ? 'teacher' : 'student';
        
        // Search matches (name, email, NSC)
        const matchesSearch = !searchTerm || 
            firstName.toLowerCase().includes(searchTerm) ||
            lastName.toLowerCase().includes(searchTerm) ||
            user.email.toLowerCase().includes(searchTerm) ||
            (user.nsc && user.nsc.toString().includes(searchTerm));
        
        // Status matches (all users are currently active)
        const matchesStatus = !statusFilter || 'active' === statusFilter;
        
        // Role matches
        const matchesRole = !roleFilter || role === roleFilter;
        
        return matchesSearch && matchesStatus && matchesRole;
    });
    
    loadUsers();
    
    // Update search results count
    updateSearchResultsCount();
}

// Clear filters function
function clearFilters() {
    document.getElementById('searchUsers').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterRole').value = '';
    filteredUsers = [...users];
    loadUsers();
    updateSearchResultsCount();
}

// Update search results count
function updateSearchResultsCount() {
    const countElement = document.getElementById('searchResultsCount');
    const searchTerm = document.getElementById('searchUsers').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const roleFilter = document.getElementById('filterRole').value;
    
    if (countElement) {
        if (searchTerm || statusFilter || roleFilter) {
            countElement.textContent = `${filteredUsers.length} of ${users.length} users`;
        } else {
            countElement.textContent = '';
        }
    }
}

// Debug functions
function debugUsers() {
    console.log('=== DEBUG INFO ===');
    console.log('Total users:', users.length);
    console.log('Filtered users:', filteredUsers.length);
    console.log('Users data:', users);
    
    // Test finding a user
    if (users.length > 0) {
        console.log('First user:', users[0]);
        console.log('First user ID:', users[0].id);
        console.log('First user roles:', users[0].roles);
    }
    
    showNotification('Debug info logged to console', 'info');
}

function reloadUsers() {
    console.log('Reloading users...');
    location.reload();
}

// Notification function
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    
    // Search functionality with debouncing
    let searchTimeout;
    document.getElementById('searchUsers').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterUsers();
        }, 300); // Wait 300ms after typing stops
    });
    
    document.getElementById('filterStatus').addEventListener('change', filterUsers);
    document.getElementById('filterRole').addEventListener('change', filterUsers);
    
    // Select all functionality
    document.getElementById('selectAll').addEventListener('change', function() {
        document.querySelectorAll('.user-checkbox').forEach(cb => {
            cb.checked = this.checked;
        });
        updateBulkActionsVisibility();
    });
    
    // Update bulk actions when checkboxes change
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('user-checkbox')) {
            updateBulkActionsVisibility();
        }
    });
    
    // Add keyboard navigation for search
    document.getElementById('searchUsers').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            filterUsers();
        }
    });
});
</script>

<style>
.user-pic img {
    object-fit: cover;
    border: 2px solid #e9ecef;
}

.user-table th {
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
}

.user-table td {
    vertical-align: middle;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.modal-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.modal-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

.badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
}

.search-input {
    position: relative;
}

.search-results-count {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.875rem;
    color: #6c757d;
    background: #f8f9fa;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
}

.search-input:focus .search-results-count {
    color: #0d6efd;
}

.user-table tbody tr {
    transition: background-color 0.2s ease;
}

.user-table tbody tr:hover {
    background-color: #f8f9fa;
}

.btn-outline-secondary:hover {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}
</style>
{% endblock page_content %}
